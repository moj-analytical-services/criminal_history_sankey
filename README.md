# Criminal History Sankey
Same underlying sankey code used in criminal_justice_statistics_sankey with criminal histories data (statistics release December 2022 data)

https://moj-analytical-services.github.io/criminal_history_sankey/


The RAP currently replaces steps 6 and 7 of the SQL Criminal Histories process on the PNC and all the manual steps on DOM1/the analytical platform, with the exception of formatting the pivot data as pivot tables. It also replaces most of the manual Excel steps in the juvenile FTE allocation data for tables Q6b and Q6c. This means that most manual steps are avoided.
There are two main stages: the first on the PNC terminals and the second on the AP. The reason for the PNC stage is that a lot of the tables are produced directly from large SQL tables. Potentially in future, the necessary tables could be transferred to the AP and then the outputs produced from the AP, but this may not be practical / more effort than it would be worth.

## 1.	On the PNC
-	First run Steps 1-5 of the Criminal Histories SQL process as normal (see \\dom1.infra.int\data\hq\102PF\Shared\CJG_OMS\OMS\Analytical Services\DIAL\03 PNC\03-Publications\01a. Offending History Chapter\Crim_Hist_FTE_Desknote_2022.docx ). Once these steps have been run the main Criminal Histories tables should have been created in SQL, except for a few tables specific to the pivots which will be created via R as part of the RAP.
-	Then run through all the SQL steps for FTE (steps 1-6) as normal (see \\dom1.infra.int\data\hq\102PF\Shared\CJG_OMS\OMS\Analytical Services\DIAL\03 PNC\03-Publications\01a. Offending History Chapter\Crim_Hist_FTE_Desknote_2022.docx ), except Step 5 does not require any manual calculations within the FTE_J_LA_Allocation_YYYYQX.xlsx Excel file – the only tab which is necessary is the All-Unknown tab which can be copied and pasted from the relevant SQL output (it should be indicated within the code or within the or desk note linked above). Please keep the name of the tab (All-Unknown) the same though and the same layout as this will avoid any errors for R referencing the tab later.
-	Once these steps have been completed, open the CH_RAP.RProj in RStudio: go to N:\Criminal History and PNC\Publications\Quarterly Publications\All Table Working\CH_RAP and open the CH_RAP R Project.
-	Open the 00_RUN.R script. All other R scripts will be run from within this file.
  -	First set the parameters at the top of this file under run. Update the `publication_year` object to the year of the publication (i.e. the year the data goes up to, not the date of the publication so for the May 2023 publication it goes up to December 2022 and 2022 should be set as the `publication_year`). Update the `snapshot` object to the PNC snapshot that is being used for the publication. The `previous_snapshot` object refer the snapshot used for the previous year’s publication, but this is not actually used by the RAP (it is there as it may be useful for future development of the RAP). `save_outputs` should be set to TRUE if you want outputs to save (otherwise the outputs don’t go any further than the R environment). 
  -	There’s a `run_script` function which is used to run other scripts. This is based on the `source` function but it adds the feature that if one of the scripts fails, the scripts run below it do not run and the option to try running a script again if it fails the first time. 
  -	To run scripts you can either select the lines you want to run then click run (or use shortcut Ctrl + Enter), or run the whole script using the shortcut Ctrl + Shift + Enter.
  -	The loading on packages is difficult on the PNC terminal and sometimes doesn’t work (you get an error often saying “gc recursive…”). This is fine, and you can just quit R and try again and it should work (it will eventually run). It can help to run the 01_2_load_packages.R script separately to other scripts. (The reason 01_1_change_library.R script is separate as this helps reduce occurrences of the error, and also the option to run the script twice helps.)
-	A brief description of what each script does can be found at the top of each script. An overview of what each stage does is given below:
  -	01_setup scripts load packages, set quarter dates (e.g. 31-12-yyyy), set the folder paths, make sure the source that is used to connect to SQL is set up correctly with the correct driver (note this depends on a script which is saved in N:\Shared Documents\R\Useful scripts\Scripts to load an SQL table\SQL to R function.R), and create general functions which are used later in the script. 
  -	05_table_ammendments runs some amendments to SQL tables which needs to be run before producing any final outputs (this was saved in the Step 7 folder of the Criminal Histories SQL process but actually needed to be run before Step 6, hence it’s order in the code).
  -	06_CH_Step_6 produces the pivot outputs. Currently this is set up to save to the Outputs folder within the RAP, but there’s code within them to save to a specific folder for the publication year (which would need to first be created manually, but this would have been done as part of earlier SQL steps). 
  -	07_CH_Step_7 produces all the published tables except for FTE tables (Q6.3, Q6.4, Q6b, and Q6c) and outputs them into excel. All the contents/notes/headings are updated at the same time, so the tables other than the FTE tables should be final at this stage. There is both an accessible table output (which is the main table individually linked on the gov.uk page) and the non-accessible tables which are also published but only with the zip file that gets uploaded. These will be output to the Outputs folder within CH_RAP.
-	Once the above steps have been completed (Criminal Histories Step 1-5, FTE Steps 1-6 (with reduced Step 5), CH_RAP) then all the necessary outputs should be ready. These are: 
  -	the 3 files for the Criminal History pivot data, 
  -	Sankey data file, 
  - two offending-histories table files (Accessible-offending-history-tables-yyyy.xlsx, offending-history-tables-YYYY.xlsx)
  -	The allocation file (only the All-Unknown tab is needed): FTE_J_LA_Allocation_YYYYQX.
-	Transfer these over to DOM1 to the folder for the publication in S:\hq\102PF\Shared\CJG_OMS\OMS\Analytical Services\DIAL\03 PNC\03-Publications\01a. Offending History Chapter (also to the S3 bucket as described below). 

## 2. On the AP
-	Upload the 
  -	two offending-histories table files (Accessible-offending-history-tables-yyyy.xlsx, offending-history-tables-YYYY.xlsx)
  -	The allocation file (only the All-Unknown tab is needed): FTE_J_LA_Allocation_YYYYQX. 
to the PNC team S3 bucket (alpha-pnc-criminal-histories), with this folder: First time entrants and Offender Histories/YYYYQX/input/. To do this you will need to set up a new folder for the publication i.e. YYYYQX = 2022Q4 for 2022 publication. Note that this folder structure need to be replicated exactly for different years (e.g. don’t give input a capital or put inputs as R won’t be able to find the files).
-	Clone this repository into R: moj-analytical-services/CriminalHistoriesRAP. Do this from a new branch (i.e. the main branch should not be updated directly, only via a pull request to merge another branch, although if you’re just running the code it won’t be necessary to make edits). Instructions for how to do this can be found on the AP guidance pages.
-	As on the PNC side, the scripts are run from the 00_RUN.R file. It has a similar list of options to set before running the code:
  -	Update the `publication_year` variable for the year of the publication as above for the PNC side. Keep the `set_folder_manual` to FALSE as then it will be able to automatically navigate the S3 buckets (unless for some reason you don’t want this).
  -	If you do not want the RAP to find it own population data using a web scrape of the ONS population estimates site, update the files stored in the pop_data folder in the S3 bucket. There are two: LAA_pop_data_series.csv which contains juvenile LA level population estimates and national_pop_data_series.csv which contains national level population estimates by gender and age group. If not using the webscrape, these need to be updated in exactly the same format they are now (i.e. extra rows for national file as it’s in long format, and an extra column for the LA file). In the LA file, the column names must be years (apart from the LA names). The files must be csv format.
  -	Also update the `MYE_pop_year` variable to be the year that the population estimates should go up to. This will normally be the publication_year – 1 (as normally we use the year before as the denominator due to publication timings, but it is included so there is functionality to use a different population lag (e.g. 2022 FTE divided by 2022 MYE population not 2022 divided by 2021).
  -	`geography_upto` should stay the same at 2020 (until the geography on the PNC is updated). 
-	Once the scripts have been run, the 4 FTE tables (Q6.3, Q6.4, Q6b, Q6c) should have been updated, and the 2 table files (Accessible-offending-history-tables-yyyy.xlsx, offending-history-tables-YYYY.xlsx) (updated with new FTE data) will appear in the output folder within the publication folder in the S3 bucket (i.e. alpha-pnc-criminal-histories/First time entrants and Offender Histories/YYYYQX/output/). These can then be downloaded and used. 
-	The population estimates used will be saved in the output file as well (in juvenile_la_population_used and national_population_used) so there’s a record of what population estimates have been used. The years within the file refer to the ONS mid-year estimate year (not the publication years). 
-	Note: The pivot tables still need to be produced manually on DOM1 as this has not be set up. This is described below and in the publication desk note linked above. 
-	For background a brief overview of what each file in the RAP does:
  -	01_setup files are very similar to those on the PNC, with exception of 01_1_load_packages.R which uses renv (whereas this is not used for the PNC scripts).
  -	02_1_read_FTE_data.R reads in the FTE pivot data and All-unknown tab of the allocation spreadsheet (note all other tabs are ignored and do not need to be updated).
  -	02_2_compile_table_Q6_3.R and 02_2_compile_table_Q6b.R compiles table Q6_3 and Q6b (the two tables not requiring population data). 
  -	02_4_scrape

